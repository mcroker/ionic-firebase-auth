{"version":3,"file":"ionic-firebase-iap.js","sources":["../../src/tokens/index.ts","../../src/iap.module.ts","../../src/interfaces/index.ts","../../src/services/iap.service.ts","../../src/ionic-firebase-iap.ts"],"sourcesContent":["// This token is the official token containing the final configuration; ie. the merge between default and user provided configurations\nimport { InjectionToken } from '@angular/core';\nimport { IAPOptions } from '../interfaces';\n\nexport const IAPOptionsToken = new InjectionToken<IAPOptions[]>('IAPOptionsToken');\n","// @angular/*\nimport { ModuleWithProviders, NgModule } from '@angular/core';\nimport { InAppPurchase2 } from '@ionic-native/in-app-purchase-2/ngx';\nimport { AuthSharedConfig, AuthSharedConfigToken } from 'ionic-firebase-auth';\nimport { IAPOptions } from './interfaces';\nimport { IAPOptionsToken } from './tokens';\n\n@NgModule({})\nexport class IAPModule {\n\n  static forRoot(options: IAPOptions): ModuleWithProviders<IAPModule> {\n    return {\n      ngModule: IAPModule,\n      providers:\n        [\n          { provide: IAPOptionsToken, useValue: options },\n          {\n            provide: InAppPurchase2,\n            useFactory: functionsInAppPurchase2Factory,\n            deps: [AuthSharedConfigToken]\n          },\n        ]\n    };\n  }\n\n}\n\nexport function functionsInAppPurchase2Factory(sharedConfig: AuthSharedConfig): InAppPurchase2 | undefined {\n  if (false === sharedConfig.services.inAppPurchase) {\n    return undefined;\n  } else {\n    return new InAppPurchase2();\n  }\n}","import { IAPProductOptions as CapacitorIAPProductOptions } from '@ionic-native/in-app-purchase-2/ngx';\n\nexport enum IAPProductTypes {\n    PAID_SUBSCRIPTION = 'PAID_SUBSCRIPTION'\n}\n\nexport interface IAPProductOptions extends CapacitorIAPProductOptions {\n    type: IAPProductTypes;\n}\n\nexport interface IAPOptions {\n    validatorUrl: string;\n    products: IAPProductOptions[];\n}\n","import { forwardRef, Inject, Injectable, NgZone, Optional } from '@angular/core';\nimport { AuthProcessService, FirebaseService, AuthSharedConfig, AuthSharedConfigToken } from 'ionic-firebase-auth';\nimport { Platform } from '@ionic/angular';\nimport { InAppPurchase2, IAPProduct } from '@ionic-native/in-app-purchase-2/ngx';\nimport { BehaviorSubject, Observable, of } from 'rxjs';\nimport { distinctUntilChanged, map } from 'rxjs/operators';\nimport { Capacitor } from '@capacitor/core';\nimport { IAPOptionsToken } from '../tokens';\nimport { IAPProductTypes, IAPOptions, IAPProductOptions } from '../interfaces';\n\nexport function slimDown(p: IAPProduct[]): Partial<IAPProduct>[];\nexport function slimDown(p: IAPProduct): Partial<IAPProduct>;\nexport function slimDown(p: IAPProduct | IAPProduct[]): Partial<IAPProduct> | Partial<IAPProduct>[] {\n  if (Array.isArray(p)) {\n    return p.map(i => slimDown(i));\n  } else {\n    return { owned: p.owned, id: p.id, canPurchase: p.canPurchase, state: p.state };\n  }\n}\n\nexport enum ProductStates {\n  owned = 'owned',\n  approved = 'approved',\n  initiated = 'initiated',\n  requested = 'requested',\n  valid = 'valid',\n  registered = 'registered',\n  downloading = 'downloading',\n  downloaded = 'downloaded',\n  finsihed = 'finished'\n\n}\n\n@Injectable({ providedIn: 'root' })\nexport class IAPurchaseService {\n\n  readonly activeStates: string[] = [\n    ProductStates.valid,\n    ProductStates.requested,\n    ProductStates.initiated,\n    ProductStates.initiated,\n    ProductStates.downloading,\n    ProductStates.downloaded,\n    ProductStates.finsihed,\n    ProductStates.owned\n  ] as string[];\n\n  private _isLoading$: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(false);\n  public isLoading$ = this._isLoading$.asObservable();\n  public get isLoading(): boolean { return this._isLoading$.value; }\n  public set isLoading(val: boolean) { this.ngZone.run(() => this._isLoading$.next(val)); }\n\n  private readonly isModuleEnabled = this.store && Capacitor.isNative && (false !== this.sharedConfig.services.inAppPurchase);\n\n  public readonly products$: Observable<IAPProduct[]> = (this.isModuleEnabled) ? this.selectAllProducts() : of([]);\n\n  public readonly activeProducts$: Observable<IAPProduct[]> = this.products$\n    .pipe(\n      map(products => products.filter(item => this.activeStates.includes(item.state) && item.title))\n    );\n\n  public readonly productsHeld$: Observable<IAPProduct[]> = this.products$\n    .pipe(map(products => products.filter(item => item.owned)));\n\n  selectAllProducts(): Observable<IAPProduct[]> {\n    if (this.isModuleEnabled) {\n      return new Observable<IAPProduct[]>(subscriber => {\n        this.store.ready(() => {\n          this.ngZone.run(() => {\n            subscriber.next(this.store.products);\n          });\n        });\n        this.store.when('product').updated((p: IAPProduct) => {\n          this.ngZone.run(() => {\n            subscriber.next(this.store.products);\n          });\n        });\n      });\n    } else {\n      return of([]);\n    }\n  }\n\n  selectProduct(product: string | IAPProduct): Observable<IAPProduct> {\n    if (this.isModuleEnabled) {\n      return new Observable<IAPProduct>(subscriber => {\n        this.store.when(product).registered((p: IAPProduct) => {\n          this.ngZone.run(() => {\n            subscriber.next(p);\n          });\n        });\n        this.store.when(product).updated((p: IAPProduct) => {\n          this.ngZone.run(() => {\n            subscriber.next(p);\n          });\n        });\n      });\n    } else {\n      return of();\n    }\n  }\n\n  selectIsOwned(product: string | IAPProduct): Observable<boolean> {\n    return this.selectProduct(product)\n      .pipe(\n        map(p => p.owned),\n        distinctUntilChanged()\n      );\n  }\n\n  selectVerified(product: string | IAPProduct = 'product'): Observable<IAPProduct> {\n    if (this.isModuleEnabled) {\n      return new Observable<IAPProduct>(subscriber => {\n        this.store.when(product).verified((p: IAPProduct) => {\n          this.ngZone.run(() => {\n            subscriber.next(p);\n          });\n        });\n      });\n    } else {\n      return of();\n    }\n  }\n\n  selectOwned(product: string | IAPProduct = 'product'): Observable<IAPProduct> {\n    if (this.isModuleEnabled) {\n      return new Observable<IAPProduct>(subscriber => {\n        this.store.when(product).owned((p: IAPProduct) => {\n          this.ngZone.run(() => {\n            subscriber.next(p);\n          });\n        });\n      });\n    } else {\n      return of();\n    }\n  }\n\n  /*\n  private updateProduct(p: IAPProduct) {\n    const i = this.products.findIndex(item => p.id === item.id);\n    this.products[i] = p;\n  }\n  */\n\n  constructor(\n    private plt: Platform,\n    @Optional() private store: InAppPurchase2,\n    private aps: AuthProcessService,\n    private ngZone: NgZone,\n    private fire: FirebaseService,\n    @Inject(forwardRef(() => IAPOptionsToken)) private options: IAPOptions,\n    @Inject(forwardRef(() => AuthSharedConfigToken)) private sharedConfig: AuthSharedConfig\n  ) {\n    if (this.isModuleEnabled && this.options.validatorUrl) {\n      this.plt.ready().then(async () => {\n        this.isLoading = true;\n\n        this.aps.user$.subscribe(\n          user => {\n            this.store.applicationUsername = user?.uid || '';\n          }\n        );\n\n        this.store.validator = this.options.validatorUrl;\n\n        /* For debug\n        this.store.when('product').updated((p: IAPProduct) => {\n           console.log('C:UPDTED>', slimDown(p));\n        });\n        */\n        this.store.when('product').approved((p: IAPProduct) => {\n          p.verify();\n        });\n\n        this.store.error((error: any) => {\n          this.fire.recordException(error);\n        });\n\n        try {\n          await this.load(this.options.products);\n        } catch (error) {\n          this.fire.recordException(error);\n        } finally {\n          this.isLoading = false;\n        }\n\n      });\n    } else {\n      this.fire.addLogMessage('Not starting IAP as not a device');\n      console.warn('Not starting IAP as not a device');\n    }\n  }\n\n  private load(products: IAPProductOptions[]): Promise<IAPProduct[]> {\n    return new Promise<IAPProduct[]>((resolve, reject) => {\n      try {\n        this.fire.addLogMessage('Error registering products');\n        this.store.register(products.map(item => {\n          let type: string;\n          switch (item.type) {\n            case IAPProductTypes.PAID_SUBSCRIPTION: type = this.store.PAID_SUBSCRIPTION; break;\n            default: throw new Error('Product type not recognised');\n          }\n          return {\n            ...item,\n            type\n          };\n        }));\n      } catch (error) {\n        this.fire.recordException(error);\n      }\n\n      this.store.ready(() => {\n        // console.log('READY READY 1>', consoleDebug(this.store.products));\n        resolve(this.store.products);\n      });\n\n      this.store.error((error: any) => {\n        this.fire.recordException(error);\n        reject(error);\n      });\n\n      try {\n        this.fire.addLogMessage('Starting store refresh');\n        this.store.refresh();\n      } catch (error) {\n        this.fire.recordException(error);\n      }\n\n    });\n  }\n\n  purchase(product: IAPProduct | string, waitForOwned = true): Observable<IAPProduct> {\n    try {\n\n      if (!this.isModuleEnabled) {\n        throw new Error('IAP Module not enabled');\n      }\n      if (!this.store.applicationUsername) {\n        throw new Error('Unable to puchase when store.applicationUsername is not set');\n      }\n      return new Observable<IAPProduct>(subscriber => {\n        this.store.when(product).requested((p: IAPProduct) => {\n          subscriber.next(p);\n        });\n        this.store.when(product).initiated((p: IAPProduct) => {\n          subscriber.next(p);\n        });\n        this.store.when(product).approved((p: IAPProduct) => {\n          subscriber.next(p);\n        });\n        this.store.when(product).verified(async (p: IAPProduct) => {\n          // console.log('P:VERIFIED>', consoleDebug(p));\n          subscriber.next(p);\n          if (!waitForOwned) {\n            subscriber.complete();\n          } // HERE WE ARE RELAIANT ON SOMETHING EXTERNAL FULLFILLING\n        });\n        this.store.once(product).owned(async (p: IAPProduct) => {\n          // console.log('P:OWNED>', consoleDebug(p));\n          subscriber.next(p);\n          subscriber.complete();\n        });\n        this.store.once(product).cancelled((p: IAPProduct) => {\n          // console.log('P:CANCELLED>', consoleDebug(p));\n          subscriber.next(p);\n          subscriber.complete();\n        });\n        this.store.once(product).error((error: any) => {\n          this.fire.recordException(error);\n          subscriber.error(error);\n        });\n        this.store.order(product).then((p: any) => {\n          // Purchase in progress!\n        }, (error: any) => {\n          this.fire.recordException(error);\n          subscriber.error(error);\n        });\n      });\n    } catch (error) {\n      this.fire.recordException(error);\n      throw error;\n    }\n  }\n\n  finish(product: IAPProduct): Promise<IAPProduct> {\n    try {\n      if (!this.isModuleEnabled) {\n        throw new Error('IAP Module not enabled');\n      }\n      return new Promise<IAPProduct>((resolve, reject) => {\n        this.store.once(product).owned((p: IAPProduct) => {\n          // console.log('P:OWNED>', consoleDebug(p));\n          resolve(p);\n        });\n        this.store.once(product).error((error: any) => {\n          this.fire.recordException(error);\n          reject(error);\n        });\n        try {\n          this.fire.addLogMessage('Starting finsih product');\n          product.finish();\n        } catch (error) {\n          this.fire.recordException(error);\n        }\n      });\n    } catch (error) {\n      this.fire.recordException(error);\n    }\n  }\n\n  // To comply with AppStore rules\n  async refresh() {\n    if (this.isModuleEnabled) {\n      try {\n        this.fire.addLogMessage('Starting store refresh');\n        await this.store.refresh();\n      } catch (error) {\n        this.fire.recordException(error);\n      }\n    }\n  }\n\n}\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './public-api';\n"],"names":[],"mappings":"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"}