!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@ionic-native/in-app-purchase-2/ngx"),require("ionic-firebase-auth"),require("@ionic/angular"),require("rxjs"),require("rxjs/operators"),require("@capacitor/core"),require("@ionic-native/in-app-purchase-2/ngx/index")):"function"==typeof define&&define.amd?define("ionic-firebase-iap",["exports","@angular/core","@ionic-native/in-app-purchase-2/ngx","ionic-firebase-auth","@ionic/angular","rxjs","rxjs/operators","@capacitor/core","@ionic-native/in-app-purchase-2/ngx/index"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self)["ionic-firebase-iap"]={},e.ng.core,e.InAppPurchase2,e.i3,e.ionic.angular,e.rxjs,e.rxjs.operators,e.Capacitor,e.InAppPurchase2)}(this,(function(e,t,r,n,o,i,s,c,a){"use strict";var u=new t.InjectionToken("IAPOptionsToken"),d=function(){function e(){}return e.forRoot=function(t){return{ngModule:e,providers:[{provide:u,useValue:t},{provide:r.InAppPurchase2,useFactory:p,deps:[n.AuthSharedConfigToken]}]}},e}();function p(e){return!1===e.services.inAppPurchase?void 0:new r.InAppPurchase2}d.decorators=[{type:t.NgModule,args:[{}]}],e.IAPProductTypes=void 0,(e.IAPProductTypes||(e.IAPProductTypes={})).PAID_SUBSCRIPTION="PAID_SUBSCRIPTION";function f(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{a(n.next(e))}catch(e){i(e)}}function c(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,c)}a((n=n.apply(e,t||[])).next())}))}function h(e,t){var r,n,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(i){return function(c){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,n=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}}Object.create;var l;Object.create;e.ProductStates=void 0,(l=e.ProductStates||(e.ProductStates={})).owned="owned",l.approved="approved",l.initiated="initiated",l.requested="requested",l.valid="valid",l.registered="registered",l.downloading="downloading",l.downloaded="downloaded",l.finsihed="finished";var v=function(){function t(t,r,n,o,a,u,d){var p=this;this.plt=t,this.store=r,this.aps=n,this.ngZone=o,this.fire=a,this.options=u,this.sharedConfig=d,this.activeStates=[e.ProductStates.valid,e.ProductStates.requested,e.ProductStates.initiated,e.ProductStates.initiated,e.ProductStates.downloading,e.ProductStates.downloaded,e.ProductStates.finsihed,e.ProductStates.owned],this._isLoading$=new i.BehaviorSubject(!1),this.isLoading$=this._isLoading$.asObservable(),this.isModuleEnabled=this.store&&c.Capacitor.isNative&&!1!==this.sharedConfig.services.inAppPurchase,this.products$=this.isModuleEnabled?this.selectAllProducts():i.of([]),this.activeProducts$=this.products$.pipe(s.map((function(e){return e.filter((function(e){return p.activeStates.includes(e.state)&&e.title}))}))),this.productsHeld$=this.products$.pipe(s.map((function(e){return e.filter((function(e){return e.owned}))}))),this.isModuleEnabled&&this.options.validatorUrl?this.plt.ready().then((function(){return f(p,void 0,void 0,(function(){var e,t=this;return h(this,(function(r){switch(r.label){case 0:this.isLoading=!0,this.aps.user$.subscribe((function(e){t.store.applicationUsername=(null==e?void 0:e.uid)||""})),this.store.validator=this.options.validatorUrl,this.store.when("product").approved((function(e){e.verify()})),this.store.error((function(e){t.fire.recordException(e)})),r.label=1;case 1:return r.trys.push([1,3,4,5]),[4,this.load(this.options.products)];case 2:return r.sent(),[3,5];case 3:return e=r.sent(),this.fire.recordException(e),[3,5];case 4:return this.isLoading=!1,[7];case 5:return[2]}}))}))})):(this.fire.addLogMessage("Not starting IAP as not a device"),console.warn("Not starting IAP as not a device"))}return Object.defineProperty(t.prototype,"isLoading",{get:function(){return this._isLoading$.value},set:function(e){var t=this;this.ngZone.run((function(){return t._isLoading$.next(e)}))},enumerable:!1,configurable:!0}),t.prototype.selectAllProducts=function(){var e=this;return this.isModuleEnabled?new i.Observable((function(t){e.store.ready((function(){e.ngZone.run((function(){t.next(e.store.products)}))})),e.store.when("product").updated((function(r){e.ngZone.run((function(){t.next(e.store.products)}))}))})):i.of([])},t.prototype.selectProduct=function(e){var t=this;return this.isModuleEnabled?new i.Observable((function(r){t.store.when(e).registered((function(e){t.ngZone.run((function(){r.next(e)}))})),t.store.when(e).updated((function(e){t.ngZone.run((function(){r.next(e)}))}))})):i.of()},t.prototype.selectIsOwned=function(e){return this.selectProduct(e).pipe(s.map((function(e){return e.owned})),s.distinctUntilChanged())},t.prototype.selectVerified=function(e){var t=this;return void 0===e&&(e="product"),this.isModuleEnabled?new i.Observable((function(r){t.store.when(e).verified((function(e){t.ngZone.run((function(){r.next(e)}))}))})):i.of()},t.prototype.selectOwned=function(e){var t=this;return void 0===e&&(e="product"),this.isModuleEnabled?new i.Observable((function(r){t.store.when(e).owned((function(e){t.ngZone.run((function(){r.next(e)}))}))})):i.of()},t.prototype.load=function(t){var r=this;return new Promise((function(n,o){try{r.fire.addLogMessage("Error registering products"),r.store.register(t.map((function(t){var n;switch(t.type){case e.IAPProductTypes.PAID_SUBSCRIPTION:n=r.store.PAID_SUBSCRIPTION;break;default:throw new Error("Product type not recognised")}return Object.assign(Object.assign({},t),{type:n})})))}catch(e){r.fire.recordException(e)}r.store.ready((function(){n(r.store.products)})),r.store.error((function(e){r.fire.recordException(e),o(e)}));try{r.fire.addLogMessage("Starting store refresh"),r.store.refresh()}catch(e){r.fire.recordException(e)}}))},t.prototype.purchase=function(e,t){var r=this;void 0===t&&(t=!0);try{if(!this.isModuleEnabled)throw new Error("IAP Module not enabled");if(!this.store.applicationUsername)throw new Error("Unable to puchase when store.applicationUsername is not set");return new i.Observable((function(n){r.store.when(e).requested((function(e){n.next(e)})),r.store.when(e).initiated((function(e){n.next(e)})),r.store.when(e).approved((function(e){n.next(e)})),r.store.when(e).verified((function(e){return f(r,void 0,void 0,(function(){return h(this,(function(r){return n.next(e),t||n.complete(),[2]}))}))})),r.store.once(e).owned((function(e){return f(r,void 0,void 0,(function(){return h(this,(function(t){return n.next(e),n.complete(),[2]}))}))})),r.store.once(e).cancelled((function(e){n.next(e),n.complete()})),r.store.once(e).error((function(e){r.fire.recordException(e),n.error(e)})),r.store.order(e).then((function(e){}),(function(e){r.fire.recordException(e),n.error(e)}))}))}catch(e){throw this.fire.recordException(e),e}},t.prototype.finish=function(e){var t=this;try{if(!this.isModuleEnabled)throw new Error("IAP Module not enabled");return new Promise((function(r,n){t.store.once(e).owned((function(e){r(e)})),t.store.once(e).error((function(e){t.fire.recordException(e),n(e)}));try{t.fire.addLogMessage("Starting finsih product"),e.finish()}catch(e){t.fire.recordException(e)}}))}catch(e){this.fire.recordException(e)}},t.prototype.refresh=function(){return f(this,void 0,void 0,(function(){var e;return h(this,(function(t){switch(t.label){case 0:if(!this.isModuleEnabled)return[3,4];t.label=1;case 1:return t.trys.push([1,3,,4]),this.fire.addLogMessage("Starting store refresh"),[4,this.store.refresh()];case 2:return t.sent(),[3,4];case 3:return e=t.sent(),this.fire.recordException(e),[3,4];case 4:return[2]}}))}))},t}();v.ɵprov=t.ɵɵdefineInjectable({factory:function(){return new v(t.ɵɵinject(o.Platform),t.ɵɵinject(a.InAppPurchase2,8),t.ɵɵinject(n.AuthProcessService),t.ɵɵinject(t.NgZone),t.ɵɵinject(n.FirebaseService),t.ɵɵinject(u),t.ɵɵinject(n.AuthSharedConfigToken))},token:v,providedIn:"root"}),v.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],v.ctorParameters=function(){return[{type:o.Platform},{type:r.InAppPurchase2,decorators:[{type:t.Optional}]},{type:n.AuthProcessService},{type:t.NgZone},{type:n.FirebaseService},{type:void 0,decorators:[{type:t.Inject,args:[t.forwardRef((function(){return u}))]}]},{type:void 0,decorators:[{type:t.Inject,args:[t.forwardRef((function(){return n.AuthSharedConfigToken}))]}]}]},e.IAPModule=d,e.IAPOptionsToken=u,e.IAPurchaseService=v,e.functionsInAppPurchase2Factory=p,e.slimDown=function e(t){return Array.isArray(t)?t.map((function(t){return e(t)})):{owned:t.owned,id:t.id,canPurchase:t.canPurchase,state:t.state}},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=ionic-firebase-iap.umd.min.js.map